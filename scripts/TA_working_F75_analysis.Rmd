---
title: "TA_WilsonFlies"
author: "Tyler Audet"
date: "19/09/2022"
output: 
  html_document: 
    toc: yes
    number_sections: yes
    keep_md: yes
editor_options: 
  chunk_output_type: console
---

# Data clean up and Analysis for morphological measurements Gen75

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(digits = 3)
```


```{r}
library(cowplot)
library(effects)
library(tidyr)
#library(skimr)
library(ggplot2)
library(ggbeeswarm)
library(ggridges)
library(glmmTMB)
library(emmeans)
library(effects)
library(dotwhisker)
library(car)
library(olsrr)
library(boot)
library(DHARMa)
library(dplyr)
library(plyr)
```


```{r}
#rawdat <- read.csv("../data/TA_Measurements_F75_working.csv")


rawdat <- read.csv("../data/TA_Measurements_F75_working.csv")

#pixels per metre = 1.8599975E-06

# Turn my unmeasureables into NAs
index_50 <- which(rawdat$Length_px < 50)

rawdat$Length_px[index_50] <- NA

#Find and remove duplicate measures
length(rawdat$Label)
length(unique(rawdat$Label))
which(duplicated(rawdat$Label))

rawdat <- rawdat[-c(which(duplicated(rawdat$Label))),]

length(rawdat$Label)

length(unique(rawdat$Label))


# Convert to um from pixel
rawdat$length_um <- rawdat$Length_px * 1.8599975

rawdat$log_size <- log2(rawdat$length_um)
```

## Use filename labels variable to break into experimental variables

Also a bit of name clean up.

```{r}
rawdat_seperate <- separate(rawdat, 
                            col = Label, 
                            into = c("Imager","Replicate","Cohort","Sex","Trait", "Individual"), sep = "_")

rawdat_seperate$Individual <- gsub(x = rawdat_seperate$Individual,
                                   pattern = ".tif", 
                                   replacement = "")

rawdat_seperate$Cohort <- gsub(x = rawdat_seperate$Cohort,
                                   pattern = "C", 
                                   replacement = "")
```

## Using Table to see the sample sizes and if they are what you expect by groups

Just looking at heads, as I assume the sample sizes will be almost identical by traits. i.e. most traits were measurable on most individuals.

```{r}
with(rawdat_seperate[rawdat_seperate$Trait == "HEAD",], 
     table(interaction(Replicate, Sex, drop = T), Cohort))
```



## Getting setup to make a wide data frame

First we need to make the individual fly identifier (fly_id).

Then we simply our lives by making a svelte version of the dataset without some of the variables we don't need for the analysis (like length in px)

```{r}
rawdat_seperate$fly_id <- paste(rawdat_seperate$Replicate, 
                                 rawdat_seperate$Cohort, 
                                 rawdat_seperate$Sex, 
                                 rawdat_seperate$Individual,
                                sep = "_")

names(rawdat_seperate)

rawdat_simple <- rawdat_seperate[, c(3,4,5,6,10,11)]

### Trying to fix sex here

rawdat_simple$fly_id <- gsub("UCTR2_0_F_10", "UCTR2_0_M_21", rawdat_simple$fly_id)

rawdat_simple$fly_id <- gsub("UCTR4_2_F_15", "UCTR4_2_M_21", rawdat_simple$fly_id)

rawdat_simple$fly_id <- gsub("NTR1_1_M_19", "NTR1_1_F_21", rawdat_simple$fly_id)

rawdat_simple$fly_id <- gsub("NTR1_2_F_10", "NTR1_2_M_21", rawdat_simple$fly_id)

rawdat_simple$fly_id <- gsub("NTR1_2_F_12", "NTR1_2_M_22", rawdat_simple$fly_id)

rawdat_simple$fly_id <- gsub("NTR1_2_F_7", "NTR1_2_M_23", rawdat_simple$fly_id)

rawdat_simple$fly_id <- gsub("NTR2_2_F_19", "NTR2_2_M_21", rawdat_simple$fly_id)

rawdat_simple$fly_id <- gsub("NTR3_0_F_15", "NTR3_0_M_21", rawdat_simple$fly_id)

rawdat_simple$fly_id <- gsub("NTR3_0_F_16", "NTR3_0_M_22", rawdat_simple$fly_id)

rawdat_simple$fly_id <- gsub("NTR3_0_F_3", "NTR3_0_M_23", rawdat_simple$fly_id)

rawdat_simple$fly_id <- gsub("NTR4_0_F_20", "NTR4_0_M_21", rawdat_simple$fly_id)

rawdat_simple$fly_id <- gsub("SCTR2_0_F_3", "SCTR2_0_M_21", rawdat_simple$fly_id)

rawdat_simple$fly_id <- gsub("SCTR1_0_M_6", "SCTR1_0_F_21", rawdat_simple$fly_id)

rawdat_simple$fly_id <- gsub("SCTR2_1_M_4", "SCTR2_1_F_21", rawdat_simple$fly_id)

rawdat_simple$fly_id <- gsub("SCTR2_2_F_4", "SCTR2_2_M_21", rawdat_simple$fly_id)

rawdat_simple$fly_id <- gsub("SCTR3_1_M_14", "SCTR3_1_F_21", rawdat_simple$fly_id)

rawdat_simple$fly_id <- gsub("UCTR1_0_F_20", "UCTR1_0_M_21", rawdat_simple$fly_id)

rawdat_simple$fly_id <- gsub("UCTR1_2_F_7", "UCTR1_2_M_21", rawdat_simple$fly_id)

#### Sex has been corrected in fly_id, now to remove old columns, reseperate out fly_id and then recreate fly_id

# I swear this seems easier than doing this in excel.

rawdat_simple <- rawdat_simple[,-c(1:3)]

rawdat_simple <- separate(rawdat_simple, 
                            col = fly_id, 
                            into = c("Replicate","Cohort","Sex","Individual"), sep = "_")

rawdat_simple <- separate(rawdat_simple, 
                            col = Replicate, 
                            into = c("Treatment", "Replicate"), sep = "R")

rawdat_simple$Trait <- tolower(rawdat_simple$Trait)

rawdat_seperate$fly_id <- paste(rawdat_seperate$Treatment,
                                rawdat_seperate$Replicate,
                                 rawdat_seperate$Cohort, 
                                 rawdat_seperate$Sex, 
                                 rawdat_seperate$Individual,
                                sep = "_")


## re-check sample sizes since sex changed sample sizes

with(rawdat_simple[rawdat_simple$Trait == "head",], 
     table(interaction(Replicate, Sex, drop = T), Cohort))

##


wide_fly <- as.data.frame(pivot_wider(rawdat_simple, 
                                      names_from = "Trait",
                                      values_from = "log_size"))

head(wide_fly)

narrow_fly <- as.data.frame(pivot_longer(wide_fly, cols = c("femur", "head", "tarsus", "thorax", "tibia", "wing"),
                                         names_to = "trait", values_to = "log_size"))


#wide_fly <- wide_fly %>%
#  separate(replicate, 
#           into = c("Treatment", "Replicate"), 
#           sep = "(?<=[A-Za-z])(?=[0-9])"
#           )

colnames(wide_fly) <- tolower(colnames(wide_fly))

wide_fly$cohort <- as.numeric(wide_fly$cohort)
```


## some checks to make sure all the data is there as expected

Structure of missing data.

Sept 22/22: TA and I looked and the images seem to be missing from the measurement set. TA will check the computer.

Images were found and measured

```{r}
missing_by_row <- apply(wide_fly, MARGIN = 1, anyNA)

dim(wide_fly)

length(missing_by_row )

temp_dat <- wide_fly[missing_by_row ,]
```

Summary statistics and stuff


**Note from Ian, use apply functions to make your life easier for this**


NOTE FROM ID, checked min, max and mean for each of the treatment units nothing seems terribly amiss.

``` {r}
# for a matrix or array, apply can be super useful
apply(wide_fly[, 6:11], MARGIN = 2, quantile, na.rm = TRUE)
# or sapply will do the same since this is a data.frame we are using
sapply(wide_fly[, 6:11], quantile, na.rm = TRUE)

with(wide_fly, 
     tapply(head, 
            INDEX = list(interaction(treatment, replicate, drop = T), cohort, sex), 
            max, na.rm = TRUE))

with(wide_fly, 
     tapply(thorax, 
            INDEX = list(interaction(treatment, replicate, drop = T), cohort, sex), 
            max, na.rm = TRUE))

with(wide_fly, 
     tapply(wing, 
            INDEX = list(interaction(treatment, replicate, drop = T), cohort, sex), 
            max, na.rm = TRUE))

with(wide_fly, 
     tapply(femur, 
            INDEX = list(interaction(treatment, replicate, drop = T), cohort, sex), 
            max, na.rm = TRUE))

with(wide_fly, 
     tapply(tibia, 
            INDEX = list(interaction(treatment, replicate, drop = T), cohort, sex), 
            max, na.rm = TRUE))

with(wide_fly, 
     tapply(tarsus, 
            INDEX = list(interaction(treatment, replicate, drop = T), cohort, sex), 
            max, na.rm = TRUE))


#skim(wide_fly)
```


## Plots of the raw data

**NOTE FROM ID:** For these plots you may find it easier to use the long data as you can facet_wrap on trait. I have not added it in.

```{r}
# Basic code and I just change the trait in question in the code to look at different traits

#Trait by sex histogram
ggplot(wide_fly, aes(x = femur, fill = treatment)) +
  facet_wrap(vars(sex)) +
  geom_histogram(binwidth = 0.05, alpha = 0.8)


# ID: I added this in
ggplot(wide_fly, aes(x = femur, colour = treatment)) +
  geom_density(alpha = 0.7) + 
  facet_wrap(vars(sex))

# NOTE FROM ID: but you may find ridge plots easier to see
ggplot(wide_fly, aes(x = femur, y = treatment, colour = treatment)) +
  geom_density_ridges(alpha = 0.5) + 
  facet_wrap(vars(sex))

#Comparison of cohorts and the effect on size

ggplot(wide_fly, aes(x = cohort, y = head, colour = treatment)) +
  geom_quasirandom(alpha = 0.4) +
  geom_smooth() +
  facet_wrap(vars(sex))

#Comparison of cohorts across treatments, sex and replicate

ggplot(wide_fly, aes(x = replicate, y = head, colour = as.factor(cohort))) +
  geom_quasirandom(alpha = 0.4) +
  facet_wrap(vars(treatment, sex))

ggplot(wide_fly, aes(x = replicate, y = thorax, colour = as.factor(cohort))) +
  geom_quasirandom(alpha = 0.4) +
  facet_wrap(vars(treatment, sex))

ggplot(wide_fly, aes(x = replicate, y = wing, colour = as.factor(cohort))) +
  geom_quasirandom(alpha = 0.4) +
  facet_wrap(vars(treatment, sex))


ggplot(wide_fly, aes(x = replicate, y = femur, colour = as.factor(cohort))) +
  geom_quasirandom(alpha = 0.4) +
  facet_wrap(vars(treatment, sex))

ggplot(wide_fly, aes(x = replicate, y = tibia, colour = as.factor(cohort))) +
  geom_quasirandom(alpha = 0.4) +
  facet_wrap(vars(treatment, sex))

ggplot(wide_fly, aes(x = replicate, y = tarsus, colour = as.factor(cohort))) +
  geom_quasirandom(alpha = 0.4) +
  facet_wrap(vars(treatment, sex))

# Comparison between two traits and if they differ in the sexes or in the cohorts
ggplot(wide_fly, aes(y = femur, x = thorax, colour = treatment)) +
     geom_jitter(width = 0, height = 0.3, alpha = 0.5) +
  facet_grid(vars(cohort, sex)) +
  geom_smooth(method = lm)
```


I need a raw data plot just to show the changes in size between treatment/trait/cohort
```{r}

narrow_fly$Treatment <- factor(narrow_fly$Treatment, levels = c("SCT", "UCT", "NT"))

ggplot(narrow_fly, aes(x = as.factor(Cohort), y = 2^(log_size), colour = Treatment, shape = Sex)) +
geom_point(alpha = 0.5, position = position_jitterdodge(
  jitter.width = 0.2,
  jitter.height = 0,
  dodge.width = 0.5)) +
  theme_bw() +
  labs(x = "Cohort", y = "Size \u03BCm") +
  scale_x_discrete(drop = FALSE) +
  facet_grid(trait~., scales="free")

```






Fitting allometry models

```{r}

#relevel sex
wide_fly$sex <- as.factor(wide_fly$sex)
wide_fly$sex <- relevel(wide_fly$sex, "F")

# Relevelling my treatments so that controls are the base level and my 'middle' treatment of UCT is the middle when plotting via emmeans and emtrends

wide_fly$treatment <- factor(wide_fly$treatment, levels = c("NT","UCT","SCT"))

wide_fly$replicate <- as.factor(wide_fly$replicate)

# centre thorax
wide_fly$thorax_c <- scale(wide_fly$thorax, 
                           center = TRUE, scale = FALSE)

write.csv(wide_fly,"../data/gen75_wideFly.csv", col.names = TRUE, row.names = FALSE)

# Is thorax changing (so does it remain a useful covariate)?
#thorax_model1 <- glmmTMB(thorax ~ (sex + treatment + cohort)^2
#                        + diag(1 + cohort| treatment:replicate),
#                             data = wide_fly)

#wing model
wing_Allometry <- glmmTMB(wing ~ (sex + treatment + thorax_c)^3
                        + diag(1 + thorax_c + sex | treatment:replicate), 
                              data = wide_fly)

summary(wing_Allometry)

#
wing_allo_supp <- plot(pairs(emtrends(wing_Allometry, ~treatment|sex, var = "thorax_c"))) +
  geom_vline(xintercept = 0, alpha = 0.5, linetype=2) +
  ylab("Wing") +
  xlab(NULL) +
  xlim(c(-0.25,0.35)) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
#

pairs(emtrends(wing_Allometry, ~treatment, var = "thorax_c"))

car::Anova(wing_Allometry)
# There is a sex effect in wing size
# There is a relationship between wiong and thorax size
# the wing to thorax size relationship is sex specific


# head
head_Allometry <- glmmTMB(head~ (sex + treatment + thorax_c)^3
                        + diag(1 + thorax_c | treatment:replicate), 
                              data = wide_fly)

summary(head_Allometry)

# Females have smaller heads?
# UCT males have larger heads than control?
# allometry in males in control is 0.80

#
head_allo_supp <- plot(pairs(emtrends(head_Allometry, ~treatment|sex, var = "thorax_c"))) +
  geom_vline(xintercept = 0, alpha = 0.5, linetype=2) +
  ylab("Head") +
  xlab(NULL) +
  xlim(c(-0.25,0.35)) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
#

pairs(emtrends(head_Allometry, ~treatment, var = "thorax_c"))

car::Anova(head_Allometry)

# there was an effect of treatment on head size
# both sex and thorax size correlate with head size
# the relationship between thorax to head ration is sex dependent

# femur
femur_Allometry <- glmmTMB(femur ~ (sex + treatment + thorax_c)^3
                        + diag(1 + sex + thorax_c | treatment:replicate), 
                              data = wide_fly)

summary(femur_Allometry)

#
femur_allo_supp <- plot(pairs(emtrends(femur_Allometry, ~treatment|sex, var = "thorax_c"))) +
  geom_vline(xintercept = 0, alpha = 0.5, linetype=2) +
  ylab("Femur") +
  xlab(NULL) +
  xlim(c(-0.25,0.35)) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
#

pairs(emtrends(femur_Allometry, ~treatment, var = "thorax_c"))
# Control females have smaller femurs
# Femur allometry is 0.89
# Female femur allometry is closer to isometry than males?
# Female femur allometry became more hypo-allometric relative to males in both treatments

car::Anova(femur_Allometry)

# sex and thorax are predictors of femur size
# the sex and thorax prediction of femur size changes with treatment ?

#Tibia model
tibia_Allometry <- glmmTMB(tibia ~ (sex + treatment + thorax_c)^3
                        + diag(1 + sex + thorax_c | treatment:replicate), 
                              data = wide_fly)

summary(tibia_Allometry)

#
tibia_allo_supp <- plot(pairs(emtrends(tibia_Allometry, ~treatment|sex, var = "thorax_c"))) +
  geom_vline(xintercept = 0, alpha = 0.5, linetype=2) +
  ylab("Tibia") +
  xlab(NULL) +
  xlim(c(-0.25,0.35)) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
#

pairs(emtrends(tibia_Allometry, ~treatment, var = "thorax_c"))


car::Anova(tibia_Allometry)
# sex and Thorax size are a predictor of tibia size


#tarsus
tarsus_Allometry <- glmmTMB(tarsus ~ (sex + treatment + thorax_c)^3
                        + diag(1 + sex + thorax_c | treatment:replicate), 
                              data = wide_fly)


summary(tarsus_Allometry)

#
tarsus_allo_supp <- plot(pairs(emtrends(tarsus_Allometry, ~treatment|sex, var = "thorax_c"))) +
  geom_vline(xintercept = 0, alpha = 0.5, linetype=2) +
  ylab("Tarsus") +
  xlab("Estimate Contrast") +
  xlim(c(-0.25,0.35))
#

pairs(emtrends(tarsus_Allometry, ~treatment, var = "thorax_c"))

car::Anova(tarsus_Allometry)
# No sex effect on tarsus size
# Body size a predictor or tarsus size
# Body size as a predictor is sex specific
# The sex effect on body size as a predictor is treatment specific

plot_grid(wing_allo_supp,head_allo_supp,femur_allo_supp,tibia_allo_supp,tarsus_allo_supp,ncol = 1, rel_heights = c(1.9,1.9,1.9,1.9,2.4))


```


```{r}

wing_trend <- cbind(as.data.frame(emtrends(wing_Allometry, ~treatment|sex, var = "thorax_c")), trait=c("wing"))
head_trend <- cbind(as.data.frame(emtrends(head_Allometry, ~treatment|sex, var = "thorax_c")), trait=c("head"))
femur_trend <- cbind(as.data.frame(emtrends(femur_Allometry, ~treatment|sex, var = "thorax_c")), trait=c("femur"))
tibia_trend <- cbind(as.data.frame(emtrends(tibia_Allometry, ~treatment|sex, var = "thorax_c")), trait=c("tibia"))
tarsus_trend <- cbind(as.data.frame(emtrends(tarsus_Allometry, ~treatment|sex, var = "thorax_c")), trait=c("tarsus"))

trends <- as.data.frame(rbind(wing_trend,head_trend,femur_trend,tibia_trend,tarsus_trend))

trends$trait <- as.factor(trends$trait)

trends$trait <- factor(trends$trait, levels = c("wing", "head", "femur", "tibia", "tarsus"))
trends$treatment <- factor(trends$treatment, levels = c("SCT", "UCT", "NT"))

##
F75_allometry <- ggplot(trends, aes(x=thorax_c.trend, y = treatment, shape = sex, colour = treatment)) +
  theme_classic() +
  facet_grid(trait~sex) +
  geom_linerange(aes(xmin=lower.CL,xmax=upper.CL), position = position_dodge(width = 0.90)) +
  geom_point(position = position_dodge(width = 0.90)) +
  xlab("Allometric slope") +
  ylab("Treatment") +
  theme(legend.position = "none") +
  scale_colour_grey(start = 0,end = 0.75,aesthetics = "colour")
##


leg_trends <- as.data.frame(rbind(femur_trend,tibia_trend,tarsus_trend))
leg_trends$trait <- factor(leg_trends$trait, levels = c("femur", "tibia", "tarsus"))
leg_trends$treatment <- factor(leg_trends$treatment, levels = c("NT", "UCT","SCT"))

leg_allometry <- ggplot(leg_trends, aes(x=treatment, y = thorax_c.trend, shape = sex, colour = treatment)) +
  theme_classic() +
  #geom_vline(aes(xintercept = 1), alpha = 0.25) +
  facet_wrap(~ trait) +
  ylab("Allometric slope") +
  scale_colour_grey(start = 0,end = 0.75,aesthetics = "colour") +
  geom_linerange(aes(ymin=lower.CL,ymax=upper.CL), position = position_dodge(width = 0.90)) +
  geom_point(position = position_dodge(width = 0.90))


## How would a contrast plot look?

fem_temp <- emtrends(femur_Allometry, pairwise ~sex|treatment, var = "thorax_c")
tib_temp <- emtrends(tibia_Allometry, pairwise ~sex|treatment, var = "thorax_c")
tar_temp <- emtrends(tarsus_Allometry, pairwise ~sex|treatment, var = "thorax_c")

fem <- cbind(as.data.frame(confint(fem_temp$contrasts)), trait=c("femur"))
tib <- cbind(as.data.frame(confint(tib_temp$contrasts)), trait=c("tibia"))
tar <- cbind(as.data.frame(confint(tar_temp$contrasts)), trait=c("tarsus"))

leg_contrast <- as.data.frame(rbind(fem,tib,tar))
leg_contrast$trait <- factor(leg_contrast$trait, levels = c("femur", "tibia", "tarsus"))
leg_contrast$treatment <- factor(leg_contrast$treatment, levels = c("NT", "UCT","SCT"))


leg_contrast <- ggplot(leg_contrast, aes(x=treatment, y = estimate, colour = treatment)) +
  theme_classic() +
  #geom_vline(aes(xintercept = 1), alpha = 0.25) +
  facet_wrap(~ trait) +
  ylab("Difference in slope slope (F-M)") +
  geom_hline(aes(yintercept = 0), linetype = 2, alpha = 0.25) +
  scale_colour_grey(start = 0,end = 0.75,aesthetics = "colour") +
  geom_linerange(aes(ymin=lower.CL,ymax=upper.CL), position = position_dodge(width = 0.90)) +
  geom_point(position = position_dodge(width = 0.90))


```



How far from isometry vector for each replicate lineage and sex?

This is from ID and isn't for the paper (right now)
```{r}
dummy_code <- with(wide_fly, 
                   interaction(replicate, treatment, sex,
                               drop = T))

VCV_matrices <- with(wide_fly, 
     by(wide_fly[, c(6:11)], 
   dummy_code,
   function(x) cov(x, use = "pairwise.complete.obs")))

# correlation matrices just to look at
print(lapply(VCV_matrices, function(x) cov2cor(x) ), digits = 2)

# proportion of variance accounted for by each eigenvalue
eig_vals_mats <- sapply(VCV_matrices, function(x) svd(x)$d/sum(svd(x)$d))

print(eig_vals_mats, digits = 2)

# principal eigenvector
eig_vecs_mats <- sapply(VCV_matrices, function(x) eigen(x)$vectors[,1])
print(eig_vecs_mats, digits = 2)

# FYI, the expectation for a vector of isometry would be coefficients of
print( rep(1/sqrt(6), 6), digits = 2)
```



Is there a change in condition dependence of any traits? First I'll use cohort s a factor to look for differences in estimated means

```{R}

#wing model

wide_fly$cohort_factor <- as.factor(wide_fly$cohort)

wing_Condition_f <- glmmTMB(wing ~ (sex + treatment + cohort_factor)^3
                        + diag(1 + thorax_c + cohort_factor| treatment:replicate), 
                              data = wide_fly)

summary(wing_Condition_f)
car::Anova(wing_Condition_f)


wing_means_f <- as.data.frame(emmeans(wing_Condition_f, specs = c("cohort_factor", "treatment", "sex")))


wing_condition_supp <- plot(pairs(emmeans(wing_Condition_f, ~treatment|sex, var = "cohort_factor"))) +
  geom_vline(xintercept = 0, alpha = 0.5, linetype=2) +
  ylab("Wing") +
  xlab(NULL) +
  xlim(c(-0.1,0.1)) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

wing_condition_plot <- ggplot(wing_means_f, aes(x = cohort_factor, y = 2^(emmean), colour = treatment, shape = sex)) +
  geom_linerange(aes(ymin = 2^(lower.CL), ymax = 2^(upper.CL)), position = position_dodge(width = 0.4), show.legend = FALSE) +
  ggtitle("Wing") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position="none") +
  theme_classic() +
  xlab("Days Starved") +
  ylab(NULL) +
  geom_point(position = position_dodge(width = 0.4),show.legend = FALSE) +
  scale_colour_grey(start = 0.75,end = 0,aesthetics = "colour")

# head
head_Condition_f <- glmmTMB(head~ (sex + treatment + cohort_factor)^3
                        + diag(1 + thorax_c + cohort_factor| treatment:replicate), 
                              data = wide_fly)

summary(head_Condition_f)
car::Anova(head_Condition_f)



head_means_f <- as.data.frame(emmeans(head_Condition_f, specs = c("cohort_factor", "treatment", "sex")))

head_condition_supp <- plot(pairs(emmeans(head_Condition_f, ~treatment|sex, var = "cohort_factor"))) +
  geom_vline(xintercept = 0, alpha = 0.5, linetype=2) +
  ylab("Head") +
  xlab(NULL) +
  xlim(c(-0.1,0.1)) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

head_condition_plot <- ggplot(head_means_f, aes(x = cohort_factor, y = 2^(emmean), colour = treatment, shape = sex)) +
  geom_linerange(aes(ymin = 2^(lower.CL), ymax = 2^(upper.CL)), position = position_dodge(width = 0.4), show.legend = FALSE) +
  ggtitle("Head") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position="none") +
  theme_classic() +
  xlab("Days Starved") +
  ylab("Length (\u00B5m)") +
  geom_point(position = position_dodge(width = 0.4),show.legend = FALSE) +
  scale_colour_grey(start = 0.75,end = 0,aesthetics = "colour")

# femur
femur_Condition_f <- glmmTMB(femur ~ (sex + treatment + cohort_factor)^3
                        + diag(1 + thorax_c + cohort_factor| treatment:replicate), 
                              data = wide_fly)

summary(femur_Condition_f)
car::Anova(femur_Condition_f)


femur_means_f <- as.data.frame(emmeans(femur_Condition_f, specs = c("cohort_factor", "treatment", "sex")))

femur_condition_supp <- plot(pairs(emmeans(femur_Condition_f, ~treatment|sex, var = "cohort_factor"))) +
  geom_vline(xintercept = 0, alpha = 0.5, linetype=2) +
  ylab("Femur") +
  xlab(NULL) +
  xlim(c(-0.1,0.1)) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

femur_condition_plot <- ggplot(femur_means_f, aes(x = cohort_factor, y = 2^(emmean), colour = treatment, shape = sex)) +
  geom_linerange(aes(ymin = 2^(lower.CL), ymax = 2^(upper.CL)), position = position_dodge(width = 0.4), show.legend = FALSE) +
  ylab("Length (\u00B5m)") +
  ggtitle("Femur") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab(NULL) +
  theme(legend.position="none") +
  theme_classic() +
  geom_point(position = position_dodge(width = 0.4), show.legend = FALSE) +
  scale_colour_grey(start = 0.75,end = 0,aesthetics = "colour")


#Tibia model
tibia_Condition_f <- glmmTMB(tibia ~ (sex + treatment + cohort_factor)^3
                        + diag(1 + thorax_c + cohort_factor| treatment:replicate), 
                              data = wide_fly)

summary(tibia_Condition_f)
car::Anova(tibia_Condition_f)



tibia_means_f <- as.data.frame(emmeans(tibia_Condition_f, specs = c("cohort_factor", "treatment", "sex")))

tibia_condition_supp <- plot(pairs(emmeans(tibia_Condition_f, ~treatment|sex, var = "cohort_factor"))) +
  geom_vline(xintercept = 0, alpha = 0.5, linetype=2) +
  ylab("Tibia") +
  xlab(NULL) +
  xlim(c(-0.1,0.1)) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

tibia_condition_plot <- ggplot(tibia_means_f, aes(x = cohort_factor, y = 2^(emmean), colour = treatment, shape = sex)) +
  geom_linerange(aes(ymin = 2^(lower.CL), ymax = 2^(upper.CL)), position = position_dodge(width = 0.4), show.legend = FALSE) +
  ggtitle("Tibia") +
  theme(plot.title = element_text(hjust = 0.5)) +
  ylab(NULL) +
  xlab(NULL) +
  theme(legend.position="none") +
  theme_classic() +
  geom_point(position = position_dodge(width = 0.4), show.legend = FALSE) +
  scale_colour_grey(start = 0.75,end = 0,aesthetics = "colour")

#tarsus
tarsus_Condition_f <- glmmTMB(tarsus ~ (sex + treatment + cohort_factor)^3
                        + diag(1 + thorax_c + cohort_factor| treatment:replicate), 
                              data = wide_fly)

summary(tarsus_Condition_f)
car::Anova(tarsus_Condition_f)


tarsus_means_f <- as.data.frame(emmeans(tarsus_Condition_f, specs = c("cohort_factor", "treatment", "sex")))

tarsus_condition_supp <- plot(pairs(emmeans(tarsus_Condition_f, ~treatment|sex, var = "cohort_factor"))) +
  geom_vline(xintercept = 0, alpha = 0.5, linetype=2) +
  ylab("Tarsus") +
  xlab(NULL) +
  xlim(c(-0.1,0.1))

tarsus_condition_plot <- ggplot(tarsus_means_f, aes(x = cohort_factor, y = 2^(emmean), colour = treatment, shape = sex)) +
  geom_linerange(aes(ymin = 2^(lower.CL), ymax = 2^(upper.CL)), position = position_dodge(width = 0.4), show.legend = FALSE) +
  ggtitle("Tarsus") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position="none") +
  theme_classic() +
  xlab(NULL) +
  ylab(NULL) +
  geom_point(position = position_dodge(width = 0.4),show.legend = FALSE) +
  scale_colour_grey(start = 0.75,end = 0,aesthetics = "colour")

```


```{r}
dummy_plot <- ggplot(tibia_means_f, aes(x = cohort_factor, y = 2^(emmean), colour = treatment, shape = sex)) +
geom_linerange(aes(ymin = 2^(lower.CL), ymax = 2^(upper.CL)), position = position_dodge(width = 0.4), show.legend = FALSE) +
  ggtitle("Tarsus") +
  theme(plot.title = element_text(hjust = 0.5)) +
  ylab(NULL) +
  xlab(NULL) +
  theme_classic() +
  guides(fill="none",shape="none") +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.title = element_text(size = 9), 
               legend.text = element_text(size = 9)) +
  geom_point(size = 9, position = position_dodge(width = 0.4)) +
  scale_colour_grey(start = 0.75,end = 0,aesthetics = "colour")


dummy_plot_2 <- ggplot(tibia_means_f, aes(x = cohort_factor, y = 2^(emmean), colour = treatment, shape = sex)) +
geom_linerange(aes(ymin = 2^(lower.CL), ymax = 2^(upper.CL)), position = position_dodge(width = 4), show.legend = FALSE) +
  ggtitle("Tarsus") +
  theme(plot.title = element_text(hjust = 5)) +
  ylab(NULL) +
  xlab(NULL) +
  theme_classic() +
  guides(fill="none",colour="none") +
  #guides(color = guide_legend(override.aes = list(size = 0.75))) +
  theme(legend.title = element_text(size = 9), 
               legend.text = element_text(size = 9)) +
  geom_point(size = 5, position = position_dodge(width = 7)) +
  scale_colour_grey(start = 0.75,end = 0,aesthetics = "colour")


treatment_legend <- get_legend(dummy_plot)
shape_legend <- get_legend(dummy_plot_2)

legend <- plot_grid(treatment_legend,shape_legend,ncol = 2, align = 'hv', axis = 'a', rel_widths = c(1, 1.5))

response_condition <- plot_grid(femur_condition_plot,tibia_condition_plot,tarsus_condition_plot,head_condition_plot,wing_condition_plot,legend,axis = "t")


## plotting supplemental contrast

plot_grid(wing_condition_supp,head_condition_supp,femur_condition_supp,tibia_condition_supp,tarsus_condition_supp,ncol = 1)


```


I also want to look at the sexual dimorphism differences in response to condition

```{r}

# Head

emmeans_for_SSD_contrast_head <- emmeans(head_Condition_f, pairwise ~sex | treatment + cohort_factor)

SSD_contrasts_head_bytreat <- contrast(emmeans_for_SSD_contrast_head[[1]], 
                          interaction = c(treatment = "trt.vs.ctrl1"), 
                          by = "cohort_factor")

as.data.frame(as.data.frame(SSD_contrasts_head_bytreat))

SSD_contrasts_head <- contrast(emmeans_for_SSD_contrast_head[[1]], 
                          interaction = c(treatment = "trt.vs.ctrl1", cohort_factor = "trt.vs.ctrl1"), 
                          by = NULL)

head_SSD <- as.data.frame(SSD_contrasts_head)

base_head <- as.data.frame(as.data.frame(confint(emmeans_for_SSD_contrast_head$contrasts)))


head_contrast_plot <- ggplot(confint(SSD_contrasts_head), aes(x=estimate, y=treatment_trt.vs.ctrl1, colour=cohort_factor_trt.vs.ctrl1)) +
  geom_pointrange(aes(xmin = upper.CL, xmax = lower.CL), position = position_dodge(width=0.75), size = 0.25) +
  ylab("Head") +
  xlab(NULL) +
  geom_vline(xintercept = 0, lty = 2 , alpha = 0.5) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position="none") +
  theme_classic() +
  scale_colour_grey(start = 0.5, end = 0) +
  xlim(c(-0.17,0.17)) +
  theme(axis.ticks = element_blank(), axis.text.x = element_blank(), legend.position = "none")

# This plot is even less intuitive

# Plotting a different way but not for the stats
head_SSD_plot <- ggplot(base_head, aes(x = cohort_factor, y = estimate,colour = treatment, group = treatment)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), show.legend = FALSE, position = position_dodge(width = 0.4), width = .1) +
  theme(legend.position="none") +
  ggtitle("Head") +
  xlab("Days Starved") +
  scale_colour_grey(start = 0,end = 0.75,aesthetics = "colour") +
  ylab(NULL) +
  theme_classic() +
  geom_line(position = position_dodge(width = 0.4), show.legend = FALSE)

# Wing

emmeans_for_SSD_contrast_wing <- emmeans(wing_Condition_f, pairwise ~sex | treatment + cohort_factor)


SSD_contrasts_wing_bytreat <- contrast(emmeans_for_SSD_contrast_wing[[1]], 
                            interaction = c(treatment = "trt.vs.ctrl1"), 
                          by = "cohort_factor")



SSD_contrasts_wing <- contrast(emmeans_for_SSD_contrast_wing[[1]], 
                            interaction = c(treatment = "trt.vs.ctrl1", cohort_factor = "trt.vs.ctrl1"), 
                          by = NULL)


wing_SSD <- as.data.frame(SSD_contrasts_wing)

base_wing <- as.data.frame(as.data.frame(confint(emmeans_for_SSD_contrast_wing$contrasts)))


wing_contrast_plot <- ggplot(confint(SSD_contrasts_wing), aes(x=estimate, y=treatment_trt.vs.ctrl1, colour=cohort_factor_trt.vs.ctrl1)) +
  geom_pointrange(aes(xmin = upper.CL, xmax = lower.CL), position = position_dodge(width=0.75), size = 0.25) +
  ylab("Wing") +
  xlab(NULL) +
  geom_vline(xintercept = 0, lty = 2 , alpha = 0.5) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position="none") +
  theme_classic() +
  scale_colour_grey(start = 0.5, end = 0) +
  xlim(c(-0.17,0.17)) +
  theme(axis.ticks = element_blank(), axis.text.x = element_blank(), legend.position = "none")

# This plot is even less intuitive

# Plotting a different way but not for the stats
wing_SSD_plot <- ggplot(base_wing, aes(x = cohort_factor, y = estimate,colour = treatment, group = treatment)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), show.legend = FALSE, position = position_dodge(width = 0.4), width = .1) +
  theme(legend.position="none") +
  ggtitle("Wing") +
  xlab("Days Starved") +
  scale_colour_grey(start = 0,end = 0.75,aesthetics = "colour") +
  ylab(NULL) +
  theme_classic() +
  geom_line(position = position_dodge(width = 0.4), show.legend = FALSE)

# Femur

emmeans_for_SSD_contrast_femur <- emmeans(femur_Condition_f, pairwise ~sex | treatment + cohort_factor)

SSD_contrasts_femur_bytreat <- contrast(emmeans_for_SSD_contrast_femur[[1]], 
                          interaction = c(treatment = "trt.vs.ctrl1"), 
                          by = "cohort_factor")

SSD_contrasts_femur <- contrast(emmeans_for_SSD_contrast_femur[[1]], 
                          interaction = c(treatment = "trt.vs.ctrl1", cohort_factor = "trt.vs.ctrl1"), 
                          by = NULL)

femur_SSD <- as.data.frame(SSD_contrasts_femur)

base_femur <- as.data.frame(as.data.frame(confint(emmeans_for_SSD_contrast_femur$contrasts)))


femur_contrast_plot <- ggplot(confint(SSD_contrasts_femur), aes(x=estimate, y=treatment_trt.vs.ctrl1, colour=cohort_factor_trt.vs.ctrl1)) +
  geom_pointrange(aes(xmin = upper.CL, xmax = lower.CL), position = position_dodge(width=0.75), size = 0.25) +
  ylab("Femur") +
  xlab(NULL) +
  geom_vline(xintercept = 0, lty = 2 , alpha = 0.5) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position="none") +
  theme_classic() +
  scale_colour_grey(start = 0.5, end = 0) +
  xlim(c(-0.17,0.17)) +
  theme(axis.ticks = element_blank(), axis.text.x = element_blank(), legend.position = "none")
# This plot is even less intuitive

# Plotting a different way but not for the stats
femur_SSD_plot <- ggplot(base_femur, aes(x = cohort_factor, y = estimate,colour = treatment, group = treatment)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), show.legend = FALSE, position = position_dodge(width = 0.4), width = .1) +
  theme(legend.position="none") +
  ggtitle("Femur") +
  scale_colour_grey(start = 0,end = 0.85,aesthetics = "colour") +
  ylim(-0.15,0.125) +
  xlab(NULL) +
  ylab(NULL) +
  theme_classic() +
  geom_line(position = position_dodge(width = 0.4), show.legend = FALSE)

# Tibia

emmeans_for_SSD_contrast_tibia <- emmeans(tibia_Condition_f, pairwise ~sex | treatment + cohort_factor)


SSD_contrasts_tibia_bytreat <- contrast(emmeans_for_SSD_contrast_tibia[[1]], 
                          interaction = c(treatment = "trt.vs.ctrl1"), 
                          by = "cohort_factor")

SSD_contrasts_tibia <- contrast(emmeans_for_SSD_contrast_tibia[[1]], 
                          interaction = c(treatment = "trt.vs.ctrl1", cohort_factor = "trt.vs.ctrl1"), 
                          by = NULL)

tibia_SSD <- as.data.frame(SSD_contrasts_tibia)

base_tibia <- as.data.frame(as.data.frame(confint(emmeans_for_SSD_contrast_tibia$contrasts)))


tibia_contrast_plot <- ggplot(confint(SSD_contrasts_tibia), aes(x=estimate, y=treatment_trt.vs.ctrl1, colour=cohort_factor_trt.vs.ctrl1)) +
  geom_pointrange(aes(xmin = upper.CL, xmax = lower.CL), position = position_dodge(width=0.75), size = 0.25) +
  ylab("Tibia") +
  xlab(NULL) +
  geom_vline(xintercept = 0, lty = 2 , alpha = 0.5) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position="none") +
  theme_classic() +
  scale_colour_grey(start = 0.5, end = 0) +
  xlim(c(-0.17,0.17)) +
  theme(axis.ticks = element_blank(), axis.text.x = element_blank(), legend.position = "none")
# This plot is even less intuitive

# Plotting a different way but not for the stats
tibia_SSD_plot <- ggplot(base_tibia, aes(x = cohort_factor, y = estimate,colour = treatment, group = treatment)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), show.legend = FALSE, position = position_dodge(width = 0.4), width = .1) +
  theme(legend.position="none") +
  ggtitle("Tibia") +
  scale_colour_grey(start = 0,end = 0.85,aesthetics = "colour") +
  ylim(-0.15,0.125) +
  xlab(NULL) +
  ylab(NULL) +
  theme_classic() +
  geom_line(position = position_dodge(width = 0.4), show.legend = FALSE) +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank())

# Tarsus

emmeans_for_SSD_contrast_tarsus <- emmeans(tarsus_Condition_f, pairwise ~sex | treatment + cohort_factor)

SSD_contrasts_tarsus_bytreat <- contrast(emmeans_for_SSD_contrast_tarsus[[1]], 
                          interaction = c(treatment = "trt.vs.ctrl1"), 
                          by = "cohort_factor")

SSD_contrasts_tarsus <- contrast(emmeans_for_SSD_contrast_tarsus[[1]], 
                          interaction = c(treatment = "trt.vs.ctrl1", cohort_factor = "trt.vs.ctrl1"), 
                          by = NULL)

tarsus_SSD <- as.data.frame(SSD_contrasts_tarsus)

base_tarsus <- as.data.frame(as.data.frame(confint(emmeans_for_SSD_contrast_tarsus$contrasts)))


tarsus_contrast_plot <- ggplot(confint(SSD_contrasts_tarsus), aes(x=estimate, y=treatment_trt.vs.ctrl1, colour=cohort_factor_trt.vs.ctrl1)) +
  geom_pointrange(aes(xmin = upper.CL, xmax = lower.CL), position = position_dodge(width=0.85), size = 0.25) +
  ylab("Tarsus") +
  xlab("F-M contrast between treatment") +
  geom_vline(xintercept = 0, lty = 2 , alpha = 0.5) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position="none") +
  theme_classic() +
  scale_colour_grey(start = 0.5, end = 0) +
  xlim(c(-0.17,0.17)) +
  theme(axis.ticks = element_blank(),legend.position = "none")


# This plot is even less intuitive

# Plotting a different way but not for the stats
tarsus_SSD_plot <- ggplot(base_tarsus, aes(x = cohort_factor, y = estimate,colour = treatment, group = treatment)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), show.legend = FALSE, position = position_dodge(width = 0.4), width = .1) +
  theme(legend.position="none") +
  ggtitle("Tarsus") +
  scale_colour_grey(start = 0,end = 0.85,aesthetics = "colour") +
  ylim(-0.15,0.125) +
  xlab(NULL) +
  ylab(NULL) +
  theme_classic() +
  geom_line(position = position_dodge(width = 0.4), show.legend = FALSE) +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank())

library(grid)

y.grob <- textGrob("Sexual Dimorphism (F - M)", rot = 90)
x.grob <- textGrob("Condition Cohort")

part_1 <- plot_grid(femur_SSD_plot,tibia_SSD_plot,tarsus_SSD_plot,ncol = 3)

part_2 <- plot_grid(y.grob,part_1,rel_widths = c(0.05,1))

part_3 <- plot_grid(part_2,x.grob,ncol = 1,rel_heights = c(1,0.1))



## Contrast plot for SSD


plot1 <- plot_grid(wing_contrast_plot,head_contrast_plot,femur_contrast_plot,tibia_contrast_plot,tarsus_contrast_plot,ncol = 1,rel_heights = c(0.65,0.65,0.65,0.65,1))


dummy_plot <- ggplot(confint(SSD_contrasts_tarsus), aes(x=estimate, y=treatment_trt.vs.ctrl1, colour=cohort_factor_trt.vs.ctrl1)) +
  geom_pointrange(aes(xmin = upper.CL, xmax = lower.CL), position = position_dodge(width=0.85), size = 0.25) +
  ylab("Tarsus") +
  xlab("F-M contrast between treatment") +
  geom_vline(xintercept = 0, lty = 2 , alpha = 0.5) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.title = "Days starved contrast") +
  theme_classic() +
  scale_colour_grey(start = 0.5, end = 0) +
  xlim(c(-0.075,0.075)) +
  theme(axis.ticks = element_blank()) +
  guides(colour=guide_legend("Days\nstarved\ncontrast"))
    

legend <- get_legend(dummy_plot)

F75_SSD_condition <- plot_grid(plot1,legend,rel_widths = c(1,0.2))






```

Below I plot SSD without the condition contrast
```{r}
SSD_wing <- as.data.frame(as.data.frame(confint(emmeans_for_SSD_contrast_wing$contrasts)))
SSD_head <- as.data.frame(as.data.frame(confint(emmeans_for_SSD_contrast_head$contrasts)))
SSD_femur <- as.data.frame(as.data.frame(confint(emmeans_for_SSD_contrast_femur$contrasts)))
SSD_tibia <- as.data.frame(as.data.frame(confint(emmeans_for_SSD_contrast_tibia$contrasts)))
SSD_tarsus <- as.data.frame(as.data.frame(confint(emmeans_for_SSD_contrast_tarsus$contrasts)))

wing_SSD_plot <- ggplot(SSD_wing[SSD_wing$cohort_factor == 0,], aes(x=estimate, y=treatment, colour=cohort_factor)) +
  geom_pointrange(aes(xmin = upper.CL, xmax = lower.CL), position = position_dodge(width=0.85), size = 0.25) +
  ylab("Wing") +
  xlab(NULL) +
  geom_vline(xintercept = 0, lty = 2 , alpha = 0.5) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position="none") +
  theme_classic() +
  scale_colour_grey(start = 0.5, end = 0) +
  xlim(c(-0.15,0.15)) +
  theme(axis.ticks = element_blank(),legend.position = "none")

head_SSD_plot <- ggplot(SSD_head[SSD_head$cohort_factor == 0,], aes(x=estimate, y=treatment, colour=cohort_factor)) +
  geom_pointrange(aes(xmin = upper.CL, xmax = lower.CL), position = position_dodge(width=0.85), size = 0.25) +
  ylab("Head") +
  xlab(NULL) +
  geom_vline(xintercept = 0, lty = 2 , alpha = 0.5) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position="none") +
  theme_classic() +
  scale_colour_grey(start = 0.5, end = 0) +
  xlim(c(-0.15,0.15)) +
  theme(axis.ticks = element_blank(),legend.position = "none")

femur_SSD_plot <- ggplot(SSD_femur[SSD_femur$cohort_factor == 0,], aes(x=estimate, y=treatment, colour=cohort_factor)) +
  geom_pointrange(aes(xmin = upper.CL, xmax = lower.CL), position = position_dodge(width=0.85), size = 0.25) +
  ylab("Femur") +
  xlab(NULL) +
  geom_vline(xintercept = 0, lty = 2 , alpha = 0.5) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position="none") +
  theme_classic() +
  scale_colour_grey(start = 0.5, end = 0) +
  xlim(c(-0.15,0.15)) +
  theme(axis.ticks = element_blank(),legend.position = "none")

tibia_SSD_plot <- ggplot(SSD_tibia[SSD_tibia$cohort_factor == 0,], aes(x=estimate, y=treatment, colour=cohort_factor)) +
  geom_pointrange(aes(xmin = upper.CL, xmax = lower.CL), position = position_dodge(width=0.85), size = 0.25) +
  ylab("Tibia") +
  xlab(NULL) +
  geom_vline(xintercept = 0, lty = 2 , alpha = 0.5) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position="none") +
  theme_classic() +
  scale_colour_grey(start = 0.5, end = 0) +
  xlim(c(-0.15,0.15)) +
  theme(axis.ticks = element_blank(),legend.position = "none")

tarsus_SSD_plot <- ggplot(SSD_tarsus[SSD_tarsus$cohort_factor == 0,], aes(x=estimate, y=treatment, colour=cohort_factor)) +
  geom_pointrange(aes(xmin = upper.CL, xmax = lower.CL), position = position_dodge(width=0.85), size = 0.25) +
  ylab("Tarsus") +
  xlab(NULL) +
  geom_vline(xintercept = 0, lty = 2 , alpha = 0.5) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position="none") +
  theme_classic() +
  scale_colour_grey(start = 0.5, end = 0) +
  xlim(c(-0.15,0.15)) +
  theme(axis.ticks = element_blank(),legend.position = "none")


F75_SSD <- plot_grid(femur_SSD_plot,tibia_SSD_plot,tarsus_SSD_plot,wing_SSD_plot,head_SSD_plot,ncol = 1,rel_heights = c(1,1,1,1,1))



```


Next I should look at the condition response trend (cohort as numeric)

```{r}
#wing model

# Making cohort numeric so that I can model trends of condition
wide_fly$cohort_numeric <- as.numeric(wide_fly$cohort)

wing_Condition_mod1 <- glmmTMB(wing ~ (sex + treatment + cohort_numeric)^3
                        + diag(1 + thorax_c + cohort_numeric| treatment:replicate), 
                              data = wide_fly)


summary(wing_Condition_mod1)
# Interaction between sex, condition, and treatments
wing_anova <- as.data.frame(car::Anova(wing_Condition_mod1))
#Interaction between sex, condition, and treatments

wing_slopes_mod1 <- emtrends(wing_Condition_mod1, ~ treatment|sex, var = "cohort_numeric")

pairs(wing_slopes_mod1)
plot(wing_slopes_mod1)
# Female wings becoming less condition dependent in treatments
# Males not responding


wing_slope <- cbind(as.data.frame(wing_slopes_mod1), trait=c("wing"))


# interaction contrast for slopes - added by ID 12/03/2025 in response to reviewer comment

wing_slopes_interactionContrast_setup <- emtrends(wing_Condition_mod1, pairwise ~ treatment|sex, var = "cohort_numeric")

wing_slopes_interaction_contrast <- contrast(wing_slopes_interactionContrast_setup[[1]], 
                                 interaction = c(Treatment = "trt.vs.ctrl1", sex = "pairwise"),
                                 by = NULL)

wing_slopes_interaction_contrast
```


```{r}
# head
head_Condition <- glmmTMB(head~ (sex + treatment + cohort_numeric)^3
                        + diag(1 + thorax_c + cohort_numeric| treatment:replicate), 
                              data = wide_fly)

summary(head_Condition)
# Minor interaction between condition sex and UCT
head_anova <- as.data.frame(car::Anova(head_Condition))
# Interaction between condition, sex, and treatment

head_slopes_mod1 <- emtrends(head_Condition, ~ treatment|sex, var = "cohort_numeric")

plot(head_slopes_mod1)
pairs(head_slopes_mod1)
# Female heads becoming less condition dependent in UCT
# Males unchanged, moving in direction of becoming less condition dependent

head_slope <- cbind(as.data.frame(head_slopes_mod1), trait=c("head"))


# femur
femur_Condition <- glmmTMB(femur ~ (sex + treatment + cohort_numeric)^3
                        + diag(1 + thorax_c + cohort_numeric| treatment:replicate), 
                              data = wide_fly)

summary(femur_Condition)
# No interaction sex:cohort:treatment
car::Anova(femur_Condition)
# Minor interaction sex:cohort:treatment

femur_slopes_mod1 <- emtrends(femur_Condition, ~ treatment|sex, var = "cohort_numeric")

plot(femur_slopes_mod1)
pairs(femur_slopes_mod1)

# Female femur unchanged, moving in different dorection in the two treatments
# Males unchanged

femur_slope <- cbind(as.data.frame(femur_slopes_mod1), trait=c("femur"))



#Tibia model
tibia_Condition <- glmmTMB(tibia ~ (sex + treatment + cohort_numeric)^3
                        + diag(1 + thorax_c + cohort_numeric| treatment:replicate), 
                              data = wide_fly)

summary(tibia_Condition)
#sexM:treatmentSCTR:cohort *
car::Anova(tibia_Condition)
# No sex:treatment:condition interaction

tibia_slopes_mod1 <- emtrends(tibia_Condition, ~ treatment|sex, var = "cohort_numeric")

plot(tibia_slopes_mod1)
pairs(tibia_slopes_mod1)
# Females in SCT are more condition dependent for tibia
# Males unchanged

tibia_slope <- cbind(as.data.frame(tibia_slopes_mod1), trait=c("tibia"))



#tarsus
tarsus_Condition <- glmmTMB(tarsus ~ (sex + treatment + cohort_numeric)^3
                        + diag(1 + thorax_c + cohort_numeric| treatment:replicate), 
                              data = wide_fly)

summary(tarsus_Condition)
# No sex:treatment:condition interaction
car::Anova(tarsus_Condition)
# no sex:treatment:condition interaction

tarsus_slopes_mod1 <- emtrends(tarsus_Condition, ~ treatment|sex, var = "cohort_numeric")

plot(tarsus_slopes_mod1)
pairs(tarsus_slopes_mod1)

# added in response to reviewer comments about interactions

tarsus_slopes_interactionContrast_setup <- emtrends(tarsus_Condition, pairwise ~ treatment|sex, var = "cohort_numeric")

tarsus_slopes_interaction_contrast <- contrast(tarsus_slopes_interactionContrast_setup[[1]], 
                                 interaction = c(Treatment = "trt.vs.ctrl1", sex = "pairwise"),
                                 by = NULL)

# Females in UCT are less condition dependent, SCT moving in the direction of less condition dependent
# Males less condition dependent

tarsus_slope <- cbind(as.data.frame(tarsus_slopes_mod1), trait=c("tarsus"))


#


con_trends <- as.data.frame(rbind(wing_slope,head_slope,femur_slope,tibia_slope,tarsus_slope))

con_trends$trait <- as.factor(con_trends$trait)

con_trends$trait <- factor(con_trends$trait, levels = c("wing", "head", "femur", "tibia", "tarsus"))
con_trends$treatment <- factor(con_trends$treatment, levels = c("SCT", "UCT", "NT"))
con_trends$cohort <- factor(con_trends$cohort,levels = c("2", "1", "0"))




# figure
trend_condition <- ggplot(con_trends, aes(x=cohort_numeric.trend, y = treatment, shape = sex, colour = treatment)) +
  geom_linerange(aes(xmin=lower.CL,xmax=upper.CL),position=position_dodge2(width = 0.9), show.legend = FALSE) +
  theme(strip.text.x = element_blank()) +
  theme_classic() +
  facet_wrap(~trait, ncol = 1, strip.position = "right") +
  ylab(NULL) +
  xlab("Slope of condition") +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(), axis.line.y = element_blank(), legend.position = "none") +
  geom_point(position = position_dodge2(width = 0.90), show.legend = FALSE) +
  scale_colour_grey(start = 0,end = 0.75,aesthetics = "colour")

first_plot <- plot_grid(response_condition,trend_condition,rel_widths = c(1,0.5))

F75_condition <- plot_grid(first_plot,rel_widths = c(1,0.1))

```


Just as a supplemental figure, I want to model thorax size between treatment groups.


```{R}


thorax_Condition_f <- glmmTMB(thorax_c ~ (sex + treatment + cohort_factor)^3
                        + diag(1 + cohort_factor | treatment:replicate), 
                              data = wide_fly)


summary(thorax_Condition_f)


car::Anova(tarsus_Condition_f)

thorax_means_f <- as.data.frame(emmeans(thorax_Condition_f, specs = c("cohort_factor", "treatment", "sex")))

thorax_condition_supp <- plot(pairs(emmeans(thorax_Condition_f, ~treatment|sex, var = "cohort_factor"))) +
  geom_vline(xintercept = 0, alpha = 0.5, linetype=2) +
  ylab("Thorax") +
  xlab("Condition response contrast") +
  xlim(c(-0.1,0.1))

thorax_condition_plot <- ggplot(thorax_means_f, aes(x = cohort_factor, y = 2^(emmean), colour = treatment, shape = sex)) +
  geom_linerange(aes(ymin = 2^(lower.CL), ymax = 2^(upper.CL)), position = position_dodge(width = 0.4), show.legend = FALSE) +
  ggtitle("Thorax F75") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position="none") +
  theme_classic() +
  ylab("Thorax size (mm)") +
  geom_point(position = position_dodge(width = 0.4)) +
  scale_colour_grey(start = 0.75,end = 0,aesthetics = "colour")


```