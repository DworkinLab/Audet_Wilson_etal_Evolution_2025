---
title: "ConditionDependence_ExperimentalEvolution"
author: "Audrey"
date: "04/11/2020"
output: 
  html_document: 
    toc: yes
    number_sections: yes
    keep_md: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

Load libraries
```{r}
library(readr)
library(ggplot2)
library(tidyr)
library(lme4)
library(glmmTMB)
library(dplyr)
library(reshape2)
library(emmeans)
library(effects)
library(car)
library(corrplot)
library(broom.mixed)
library(dotwhisker)
library(MCMCglmm)
```

Load and clean data
```{r}
condition_data2 <- read.csv("../data/Results.csv")
##
## Skip to line 133 *** TA


scales <- read.csv("../data/anx_filesForScale/ScaleAndFileName_raw.csv")


names(scales)  <- c("fileName", "metresPerPixel")
condition_data2$scale <- scales$metresPerPixel[match(condition_data2$Label, scales$fileName)]

condition_data <- condition_data2 %>% separate(Label, 
                            c("Initials", "Treatment", "Replicate","Generation",
                              "Cohort", "Sex", "Individual", "Trait"))


summary(condition_data)

str(condition_data)

condition_data2 <- read_csv("../data/AW_ConditionData2.csv")

```


## DON'T NEED TO RUN THIS, SAVED AS NEW CSV FILE (Skip to line 133)
## changing types of variables, and adjusting scale.
```{r}
condition_data$Treatment <- as.factor(condition_data$Treatment)
condition_data$Sex <- as.factor(condition_data$Sex)
condition_data$Replicate <- as.factor(condition_data$Replicate)
condition_data$Cohort <- as.numeric(condition_data$Cohort)
condition_data$Individual <- as.numeric(condition_data$Individual)

condition_data$scale_mm <- 10^3 * condition_data$scale  # mm_per_pixel

condition_data$length_mm <- with(condition_data, scale_mm*Length)
```



## Now the less fun part

 Need to label first leg segment is femur, second as tibia. Unfortunately the order of images was not always the same per specimen.
 
 

### legs

```{r}
legs_dat <- data.frame(condition_data[condition_data$Trait == "L",])

dim(legs_dat)

legs_dat$NewTrait <- c("femur", "tibia")

```

### wings

```{r}
wings_dat <- data.frame(condition_data[condition_data$Trait == "W",])

dim(wings_dat)

wings_dat$NewTrait <- c("wingLength", "wingWidth")
```


### head and thorax

```{r}
other_dat <- data.frame(condition_data[condition_data$Trait == "H"  | condition_data$Trait == "T",])

dim(other_dat)

other_dat$NewTrait <- other_dat$Trait
```


### remake as a new data table

```{r}

condition_data2 <- rbind(legs_dat, wings_dat, other_dat)

str(condition_data2)

condition_data2$NewTrait <- as.factor(condition_data2$NewTrait)
levels(condition_data2$NewTrait)

levels(condition_data2$NewTrait)[2:3] <- c("head", "thorax")


condition_data$Cohort0 <- condition_data$Cohort - 1  # Makes Cohort 1 "the intercept"
condition_data2$Cohort0 <- as.factor(condition_data2$Cohort0)

condition_data$length_um <- condition_data$length_mm * 1000


write.csv(condition_data, "../data/tarsus_ConditionData.csv")
```


# TA analysis is giving different numbers to AW analysis, so I just want to check the numbers are the same early on

```{r}
head(condition_data2)

condition_data2$log_length <- log2(condition_data2$length_mm*1000)

condition_data2$fly_id <- paste(rawdat$Replicate, 
                                 rawdat$Cohort0, 
                                 rawdat$Sex,
                                 rawdat$Individual,
                                sep = "_")

condition_data2_simple <- condition_data2[, c(2,3,6,7,13,14,15,16)]

condition_data2_simple <- separate(condition_data2_simple, 
                            col = fly_id, 
                            into = c("Replicate","Cohort","Sex","Individual"), sep = "_")


# recheck sample sizes
with(condition_data2_simple[condition_data2_simple$NewTrait == "head",], 
     table(interaction(Replicate, Sex, drop = T), Cohort))
#

wide_fly <- as.data.frame(pivot_wider(condition_data2_simple, 
                                      names_from = "NewTrait",
                                      values_from = "log_length"))

colnames(wide_fly) <- tolower(colnames(wide_fly))

wide_fly$cohort <- as.numeric(wide_fly$cohort)


apply(wide_fly[, 7:12], MARGIN = 2, quantile, na.rm = TRUE)
```




## premature model
- just looking at one trait (say thorax) in high condition

```{r}
prem_model <- lmer(length_mm ~ Treatment*Sex + (1 |Treatment:Replicate),
                   data = condition_data2,
                   subset = (condition_data2$NewTrait == "tibia" & condition_data2$Cohort0 == 0) )


summary(prem_model)

car::Anova(prem_model)
```

# Let's include condition dependence 
```{r}
prem_model_2 <- lmer(length_mm ~ Treatment*Sex*Cohort0 + (1 + Cohort0|Treatment:Replicate),
                   data = condition_data2,
                   subset = (condition_data2$NewTrait == "tibia") )


summary(prem_model_2)

car::Anova(prem_model_2)

prem_model_2_tmb <- glmmTMB(length_mm ~ Treatment*Sex*Cohort0 + diag(1 + Cohort0|Treatment:Replicate),
                   data = condition_data2[condition_data2$NewTrait == "tibia",])

summary(prem_model_2_tmb)
car::Anova(prem_model_2_tmb)
```


##Changing types of variables
```{r}
condition_data2$Treatment <- as.factor(condition_data2$Treatment)
condition_data2$Sex <- as.factor(condition_data2$Sex)
condition_data2$Replicate <- as.factor(condition_data2$Replicate)
condition_data2$Cohort0 <- as.numeric(condition_data2$Cohort0)
condition_data2$Individual <- as.numeric(condition_data2$Individual)
```


###Plotting

```{r}
ggplot(condition_data2, aes(Cohort0, length_mm, colour = NewTrait)) +
  geom_boxplot() +
  facet_wrap(~Sex)

condition_data2 %>% 
  group_by(NewTrait, Sex, Cohort0, Treatment) %>% 
  summarize(avg_length = mean(length_mm)) %>% 
  ggplot(aes(as.numeric(Cohort0), avg_length, colour = Treatment, shape = Sex)) +
  geom_line() +
  geom_point() +
  facet_wrap(~NewTrait, scales = "free_y") #this but with error bars?

#I am worried that some of my UCT data is lower than it should be. During the condition manipulation, eggs for UCT R3 and R4 were collected one day later than the other treatments due to a lack of eggs. Although otherwise treated the same, these individuals had lower survivorship and appeared to be smaller. Try omitting these from the data to see what changes.

test_dat <- condition_data2[!(condition_data2$Replicate == "4" & condition_data2$Treatment == "UCT"),]
test_dat2 <- test_dat[!(test_dat$Replicate == "3" & test_dat$Treatment == "UCT"),]

test_dat2 %>% 
  group_by(NewTrait, Sex, Cohort0, Treatment) %>% 
  summarize(avg_length = mean(length_mm)) %>% 
  ggplot(aes(as.numeric(Cohort0), avg_length, colour = Treatment, shape = Sex)) +
  geom_line() +
  geom_point() +
  facet_wrap(~NewTrait, scales = "free_y")

#There are differences after omitting the replicates, however the overall trends between treatments don't seem to have changed. Should we omit? Would we expect eggs laid one day later to have significantly lower survivorship/adult size?
```

##Looks like there are some values that don't make sense. There are a few males that are much larger than the females in cohort 0.Female data in general looks good.

##Find outliers
```{r}
outlier_thorax <- subset(condition_data2, NewTrait == "thorax")
outlier_thorax <- subset(outlier_thorax, length_mm > 1.15)
outlier_thorax #remeasured as 633.35 pixels, looks real

outlier_head <- subset(condition_data2, NewTrait == "head" & Sex == "M")
outlier_head <- subset(outlier_head, length_mm > 0.9) #check the cohort 0 male and cohort 2 male
outlier_head #double check 6236 and 7990
#remeasured at 497.064 and 572.180 (pixels), seem real 

outlier_tibia <- subset(condition_data2, NewTrait == "tibia" & Sex == "M")
outlier_tibia <- subset(outlier_tibia, length_mm >0.55)
outlier_tibia #check 60 and 2230
#remeasured at 322.223 and 327.998, first measurement 4 pixels off but second looks good

outlier_wingL <- subset(condition_data2, NewTrait == "wingLength" & Sex == "M")
outlier_wingL <- subset(outlier_wingL, length_mm < 1.4)
outlier_wingL # check 5243
#remeasured at 746.223, looks good
```
## Does not look like any outliers need to be removed?


Relative sizes of traits vs. relative body size
```{r}
condition_data_wide <- dcast(condition_data2, 
                             Treatment + Replicate + Sex + Individual + Cohort0 ~ NewTrait,
                             value.var = "length_mm")

condition_data_wide <- gather(condition_data_wide, "OtherTraits", "length_mm", femur, head, tibia, wingLength, wingWidth)  
head(condition_data_wide)


condition_data_wide$thorax_c <- condition_data_wide$thorax - mean(condition_data_wide$thorax, na.rm = T)
#condition_data_wide$thorax_c <- scale(condition_data_wide$thorax, center = TRUE, scale = FALSE)

ggplot(condition_data_wide, aes(log2(thorax), log2(length_mm), colour = Treatment, shape = Sex)) + 
  geom_point(alpha = 0.25, size = 3) +
  #facet_wrap(~OtherTraits:Sex) +
  facet_grid(rows = vars(OtherTraits), cols = vars(Sex))

ggplot(condition_data_wide, aes(log2(thorax), log2(length_mm), colour = OtherTraits)) + 
  geom_point() +
  facet_grid(cols = vars(Treatment), rows = vars(Sex))
```

## Modeling


##Model for each trait
##Using untransformed values for size
```{r}
femur_model <- lmer(length_mm ~ (Treatment + Sex + Cohort0 + thorax_c)^2 + (1 + Cohort0 + Sex |Treatment:Replicate),
                   data = condition_data_wide,
                   subset = (condition_data_wide$OtherTraits == "femur"))

summary(femur_model)

Anova(femur_model)

est_femur <- emtrends(femur_model, 
         c("Treatment", "Sex"),
         var = "thorax_c", data = condition_data_wide)

# est_femur <- emtrends(femur_model, 
#          c("Treatment", "Sex"),
#          var = "thorax_c")

plot(allEffects(femur_model))
plot(est_femur)


```

```{r}
tibia_model <- lmer(length_mm ~ (Treatment + Sex + Cohort0 + thorax_c)^2 + (1 + Cohort0 + Sex |Treatment:Replicate),
                   data = condition_data_wide,
                   subset = (condition_data_wide$OtherTraits == "tibia"))

summary(tibia_model)

Anova(tibia_model)

est_tibia <- emtrends(tibia_model, 
         c("Treatment", "Sex"),
         var = "thorax_c", data = condition_data_wide)

# est_tibia <- emtrends(tibia_model, 
#          c("Treatment", "Sex"),
#          var = "thorax_c")
plot(est_tibia)

plot(allEffects(tibia_model))
```

```{r}
head_model <- lmer(length_mm ~ (Treatment + Sex + Cohort0 + thorax_c)^2 + (1 + Cohort0 + Sex |Treatment:Replicate),
                   data = condition_data_wide,
                   subset = (condition_data_wide$OtherTraits == "head"))

summary(head_model)

Anova(head_model)

est_head <- emtrends(head_model, 
         c("Treatment", "Sex"),
         var = "thorax_c", data = condition_data_wide)
plot(est_head)
plot(allEffects(head_model))
```

```{r}
wingL_model <- lmer(length_mm ~ (Treatment + Sex + Cohort0 + thorax_c)^2 + (1 + Cohort0 + Sex |Treatment:Replicate),
                   data = condition_data_wide,
                   subset = (condition_data_wide$OtherTraits == "wingLength"))

summary(wingL_model)

car::Anova(wingL_model)

est_wingL <- emtrends(wingL_model, 
         c("Treatment", "Sex"),
         var = "thorax_c", data = condition_data_wide)
plot(est_wingL)

plot(allEffects(wingL_model))
```

```{r}
wingW_model <- lmer(length_mm ~ (Treatment + Sex + Cohort0 + thorax_c)^2 + (1 + Cohort0 + Sex |Treatment:Replicate),
                   data = condition_data_wide,
                   subset = (condition_data_wide$OtherTraits == "wingWidth"))

summary(wingW_model)

car::Anova(wingW_model)

est_wingW <- emtrends(wingW_model, 
         c("Treatment", "Sex"),
         var = "thorax_c", data = condition_data_wide)
plot(est_wingW)
plot(allEffects(wingW_model))
```


##Trait size changes with condition

#Preparing data
```{r}
femur_fit <- as.data.frame(predictorEffects(femur_model, ~ Cohort0, focal.levels = 3))
femur_fit <- as.data.frame(femur_fit)
femur_fit <- femur_fit %>% 
  rename(Cohort0 = Cohort0.Cohort0, Treatment = Cohort0.Treatment, Sex = Cohort0.Sex,
         thorax_c = Cohort0.thorax_c, femur_fit = Cohort0.fit, femur_se = Cohort0.se, 
         femur_lower = Cohort0.lower, femur_upper = Cohort0.upper)

tibia_fit <- as.data.frame(predictorEffects(tibia_model, ~ Cohort0, focal.levels = 3))
tibia_fit <- as.data.frame(tibia_fit)
tibia_fit <- tibia_fit %>% 
    rename(Cohort0 = Cohort0.Cohort0, Treatment = Cohort0.Treatment, 
           Sex = Cohort0.Sex, thorax_c = Cohort0.thorax_c, tibia_fit = Cohort0.fit, 
           tibia_se = Cohort0.se, tibia_lower = Cohort0.lower, 
           tibia_upper = Cohort0.upper)

head_fit <- as.data.frame(predictorEffects(head_model, ~ Cohort0, focal.levels = 3))
head_fit <- as.data.frame(head_fit)
head_fit <- head_fit %>% 
    rename(Cohort0 = Cohort0.Cohort0, Treatment = Cohort0.Treatment, 
           Sex = Cohort0.Sex, thorax_c = Cohort0.thorax_c, head_fit = Cohort0.fit, 
           head_se = Cohort0.se, head_lower = Cohort0.lower, 
           head_upper = Cohort0.upper)

wingL_fit <- as.data.frame(predictorEffects(wingL_model, ~ Cohort0, focal.levels = 3))
wingL_fit <- as.data.frame(wingL_fit)
wingL_fit <- wingL_fit %>% 
    rename(Cohort0 = Cohort0.Cohort0, Treatment = Cohort0.Treatment, 
           Sex = Cohort0.Sex, thorax_c = Cohort0.thorax_c, wingL_fit = Cohort0.fit, 
           wingL_se = Cohort0.se, wingL_lower = Cohort0.lower, 
           wingL_upper = Cohort0.upper)

wingW_fit <- as.data.frame(predictorEffects(wingW_model, ~ Cohort0, focal.levels = 3))
wingW_fit <- as.data.frame(wingW_fit)
wingW_fit <- wingW_fit %>% 
    rename(Cohort0 = Cohort0.Cohort0, Treatment = Cohort0.Treatment, 
           Sex = Cohort0.Sex, thorax_c = Cohort0.thorax_c, wingW_fit = Cohort0.fit, 
           wingW_se = Cohort0.se, wingW_lower = Cohort0.lower,
           wingW_upper = Cohort0.upper)

model_fits <- cbind(femur_fit, tibia_fit[, 5:8], head_fit[, 5:8], wingL_fit[, 5:8], wingW_fit[, 5:8])

model_fits <- model_fits %>% 
  gather(v, value, femur_fit:wingW_upper) %>% 
  separate(v, c("ModelTrait", "col")) %>% 
  arrange(Cohort0) %>% 
  spread(col, value)
```

#Plots
```{r}
#average fitted values and then plot, not sure what to do with errorbars in this case
ggplot(model_fits, aes(Cohort0, fit, colour = Treatment, shape = Sex)) +
  geom_pointrange(aes(min = lower, max = upper)) +
  theme_classic(base_size = 24) +
  scale_colour_manual(breaks = c("NT", "UCT", "SCT"), values = c("#616161", "#E69F00", "#039BE5")) +
  scale_x_continuous(breaks = seq(0, 2, 1)) +
  facet_wrap(~ModelTrait, scales = "free_y")
#I don't understand what is happening with the thorax here. Looking at the datasets for each model, thorax_c is split into 5 groups
```

#Allometries
```{r}
femur_allom <- as.data.frame(predictorEffects(femur_model, ~ thorax_c))
femur_allom <- as.data.frame(femur_allom)
femur_allom <- femur_allom %>% 
  rename(thorax_c = thorax_c.thorax_c, Treatment = thorax_c.Treatment, 
         Sex = thorax_c.Sex, Cohort0 = thorax_c.Cohort0, femur_fit = thorax_c.fit,
         femur_se = thorax_c.se, femur_lower = thorax_c.lower, 
         femur_upper = thorax_c.upper)

tibia_allom <- as.data.frame(predictorEffects(tibia_model, ~ thorax_c))
tibia_allom <- as.data.frame(tibia_allom)
tibia_allom <- tibia_allom %>% 
  rename(thorax_c = thorax_c.thorax_c, Treatment = thorax_c.Treatment, 
         Sex = thorax_c.Sex, Cohort0 = thorax_c.Cohort0, tibia_fit = thorax_c.fit,
         tibia_se = thorax_c.se, tibia_lower = thorax_c.lower, 
         tibia_upper = thorax_c.upper)

head_allom <- as.data.frame(predictorEffects(head_model, ~ thorax_c))
head_allom <- as.data.frame(head_allom)
head_allom <- head_allom %>% 
  rename(thorax_c = thorax_c.thorax_c, Treatment = thorax_c.Treatment, 
         Sex = thorax_c.Sex, Cohort0 = thorax_c.Cohort0, head_fit = thorax_c.fit,
         head_se = thorax_c.se, head_lower = thorax_c.lower, 
         head_upper = thorax_c.upper)

wingL_allom <- as.data.frame(predictorEffects(wingL_model, ~ thorax_c))
wingL_allom <- as.data.frame(wingL_allom)
wingL_allom <- wingL_allom %>% 
  rename(thorax_c = thorax_c.thorax_c, Treatment = thorax_c.Treatment, 
         Sex = thorax_c.Sex, Cohort0 = thorax_c.Cohort0, wingL_fit = thorax_c.fit,
         wingL_se = thorax_c.se, wingL_lower = thorax_c.lower, 
         wingL_upper = thorax_c.upper)

wingW_allom <- as.data.frame(predictorEffects(wingW_model, ~ thorax_c))
wingW_allom <- as.data.frame(wingW_allom)
wingW_allom <- wingW_allom %>% 
  rename(thorax_c = thorax_c.thorax_c, Treatment = thorax_c.Treatment, 
         Sex = thorax_c.Sex, Cohort0 = thorax_c.Cohort0, wingW_fit = thorax_c.fit,
         wingW_se = thorax_c.se, wingW_lower = thorax_c.lower, 
         wingW_upper = thorax_c.upper)

model_alloms <- cbind(femur_allom, tibia_allom[, 5:8], head_allom[, 5:8], wingL_allom[, 5:8], wingW_allom[, 5:8])

model_alloms <- model_alloms %>% 
  gather(v, value, femur_fit:wingW_upper) %>% 
  separate(v, c("ModelTrait", "col")) %>% 
  arrange(Treatment) %>% 
  spread(col, value)
```

```{r}
#smooth out fitted values
ggplot(model_alloms, aes(log2(thorax_c), log2(fit), colour = Treatment)) +
         geom_smooth(method = "lm", se = F, aes(lty = Sex)) +
  facet_wrap(~ModelTrait, scales = "free_y")

ggplot(model_alloms, aes(log2(thorax_c), log2(fit))) +
         geom_ribbon(aes(min = lower, max = upper, fill = Treatment)) +
  facet_wrap(~ModelTrait, scales = "free_y")
```


## Multivariate mixed model (added by ID, Nov 20)



```{r}
condition_data2$units <- with(condition_data2, interaction(Treatment, Replicate, Generation, Cohort0, Sex, Individual, drop = T))
```

```{r}
multivariate_mod1 <- lmer(length_mm ~ NewTrait:(Treatment + Sex + as.numeric(Cohort0))^2 - 1 +
                            (NewTrait*Sex -1 |Treatment:Replicate) +
                            (NewTrait -1 | units),
                   data = condition_data2,
                   control=lmerControl(optCtrl=list(ftol_abs=1e-10),
                                      optimizer="bobyqa",
                                      check.nobs.vs.nlev="ignore",
                                      check.nobs.vs.nRE="ignore"))



all(abs(getME(multivariate_mod1,"theta"))>1e-4)
VarCorr(multivariate_mod1)


vv1 <- VarCorr(multivariate_mod1)

names(vv1)[2] <- "TreatmentReplicate"

## fix unit variance-covariance by adding residual variance:
diag(vv1$units) <- diag(vv1$units)+sigma(multivariate_mod1)^2

corrplot.mixed(cov2cor(vv1$TreatmentReplicate), upper="ellipse")

corrplot.mixed(cov2cor(vv1$units), upper="ellipse")


summary(multivariate_mod1)

plot(emmeans(multivariate_mod1, 
             specs = ~ Sex:Treatment| NewTrait),
         xlab = "length in mm",
         ylab = "")
```


```{r}
cc1 <- tidy(multivariate_mod1,effect="fixed") %>%
  tidyr::separate(term,into=c("trait","fixeff"),extra="merge",
                  remove=FALSE)
dwplot(cc1)+facet_wrap(~fixeff,scale="free",ncol=2)+
  geom_vline(xintercept=0,lty=2)
```

## Data for Ian
```{r}
condition_data_traits <- dcast(condition_data2, 
                             Treatment + Replicate + Sex + Individual + Cohort0 ~ NewTrait,
                             value.var = "length_mm")
head(condition_data_traits)
```


### New part from Ian to examine the PCA and multivariate mixed model


### First just a PCA
```{r}


names(condition_data_traits)

condition_data_traits$log2_thorax <- log2(condition_data_traits$thorax)
condition_data_traits$log2_femur <- log2(condition_data_traits$femur)
condition_data_traits$log2_tibia <- log2(condition_data_traits$tibia)
condition_data_traits$log2_head <- log2(condition_data_traits$head)
condition_data_traits$log2_wingL <- log2(condition_data_traits$wingLength)
condition_data_traits$log2_wingW <- log2(condition_data_traits$wingWidth)

pca_all <- prcomp(condition_data_traits[ ,12:17]) # on covariance matrix of log transformed traits
plot(pca_all)
biplot(pca_all)
summary(pca_all)

condition_data_traits_new <- data.frame(condition_data_traits, pca_all$x)

pca_all$rotation
pc_plot1_2 <- ggplot(condition_data_traits_new, aes(y = PC1, x = PC2, shape = Treatment, color = Sex)) + geom_point(alpha = 0.75, size = 2)

pc_plot1_2

pc_plot2_3 <- ggplot(condition_data_traits_new, aes(y = PC3, x = PC2, shape = Treatment, color = Sex)) + geom_point(alpha = 0.75, size = 2)

pc_plot2_3

```

### Looking at treatment specific PCAs (comparing directions etc)


```{r}


pca_NT <- prcomp(condition_data_traits[ condition_data_traits$Treatment == "NT", 12:17])
dim(pca_NT$x)

pca_UCT <- prcomp(condition_data_traits[ condition_data_traits$Treatment == "UCT", 12:17])
dim(pca_UCT$x)

pca_SCT <- prcomp(condition_data_traits[ condition_data_traits$Treatment == "SCT", 12:17])
dim(pca_SCT$x)

# distribution of eigenvalues (proportion sizes)
pca_NT$sdev/(sum(pca_NT$sdev))
pca_UCT$sdev/(sum(pca_UCT$sdev))
pca_SCT$sdev/(sum(pca_SCT$sdev))


# directions
pca_NT$rotation
pca_UCT$rotation
pca_SCT$rotation
```


## Let's do a bit more formal checks

```{r}


# quick and dirty checks (for each sex)

cov_NT_M <- cov(condition_data_traits[ condition_data_traits$Treatment == "NT" & condition_data_traits$Sex == "M", 12:17])
cov_UCT_M <- cov(condition_data_traits[ condition_data_traits$Treatment == "UCT"  & condition_data_traits$Sex == "M", 12:17])
cov_SCT_M <- cov(condition_data_traits[ condition_data_traits$Treatment == "SCT" & condition_data_traits$Sex == "M", 12:17])

cov_NT_F <- cov(condition_data_traits[ condition_data_traits$Treatment == "NT" & condition_data_traits$Sex == "F", 12:17])
cov_UCT_F <- cov(condition_data_traits[ condition_data_traits$Treatment == "UCT"  & condition_data_traits$Sex == "F", 12:17])
cov_SCT_F <- cov(condition_data_traits[ condition_data_traits$Treatment == "SCT" & condition_data_traits$Sex == "F", 12:17])

Ddivergence(cov_SCT_M, cov_UCT_M) # d-divergence from Ovaskainen 2008
Ddivergence(cov_NT_M, cov_UCT_M)
Ddivergence(cov_NT_M, cov_SCT_M)

Ddivergence(cov_SCT_F, cov_UCT_F) 
Ddivergence(cov_NT_F, cov_UCT_F)
Ddivergence(cov_NT_F, cov_SCT_F)

Ddivergence(cov_SCT_F, cov_SCT_M) 
Ddivergence(cov_UCT_F, cov_UCT_M) 
Ddivergence(cov_NT_F, cov_NT_M) 


plotsubspace(cov_NT_M, cov_NT_F)

plotsubspace(cov_NT_M, cov_UCT_M, shadeCA = F, shadeCB = F )
plotsubspace(cov_SCT_M, cov_UCT_M)

# orientation of covariance matrices (has multivariate allometries changed much)
krzanowski.test(cov_NT_M, cov_UCT_M, vecsA = 1:3, vecsB = 1:3)
krzanowski.test(cov_NT_M, cov_SCT_M, vecsA = 1:3, vecsB = 1:3)
krzanowski.test(cov_UCT_M, cov_SCT_M, vecsA = 1:3, vecsB = 1:3)

krzanowski.test(cov_NT_F, cov_UCT_F, vecsA = 1:3, vecsB = 1:3)
krzanowski.test(cov_NT_F, cov_SCT_F, vecsA = 1:3, vecsB = 1:3)
krzanowski.test(cov_UCT_F, cov_SCT_F, vecsA = 1:3, vecsB = 1:3)

krzanowski.test(cov_NT_M, cov_NT_F, vecsA = 1:3, vecsB = 1:3)
krzanowski.test(cov_UCT_M, cov_UCT_F, vecsA = 1:3, vecsB = 1:3)
krzanowski.test(cov_SCT_M, cov_SCT_F, vecsA = 1:3, vecsB = 1:3)


```



### multivariate mixed model (for location effects)


```{r}

prior.model.1 <- list( R = list(V=diag(5)/5, nu=0.004),  
                       G = list(G1=list(V=diag(5)/5, nu=0.004)))

mod_trial1 <- MCMCglmm(cbind(log2_femur, log2_tibia, log2_head, log2_wingL, log2_wingW) ~ 
           trait:(Treatment*Sex*log2_thorax) -1, 
         random =~ us(trait):(Treatment:Replicate),
         rcov =~ us(trait):units,
         data = condition_data_traits,
         family = rep("gaussian", 5),
         prior = prior.model.1,
         nitt= 10000, burnin= 2000, thin=10)

tt <- tidy(mod_trial1)
tt_comb <- bind_rows(MCMCglmm=tt,.id="model") %>%
    filter(effect=="fixed")

dwplot(tt_comb) + geom_vline(xintercept=0,lty=2)

plot(emmeans(mod_trial1,
             specs = ~ Sex|Treatment, data = condition_data_traits ))

```


end Ian's new part

## Testing models with omitted data
```{r}
data_wide2 <- condition_data_wide[!(condition_data_wide$Replicate == "4" & condition_data_wide$Treatment == "UCT"),]
data_wide2 <- data_wide2[!(data_wide2$Replicate == "3" & data_wide2$Treatment == "UCT"),]

femur_mod2 <- lmer(length_mm ~ (Treatment + Sex + Cohort0 + thorax_c)^2 + (1 + Cohort0 + Sex |Treatment:Replicate),
                   data = data_wide2,
                   subset = (data_wide2$OtherTraits == "femur"))
Anova(femur_mod2)

tibia_mod2 <- lmer(length_mm ~ (Treatment + Sex + Cohort0 + thorax_c)^2 + (1 + Cohort0 + Sex |Treatment:Replicate),
                   data = data_wide2,
                   subset = (data_wide2$OtherTraits == "tibia"))
Anova(tibia_mod2)

head_mod2 <- lmer(length_mm ~ (Treatment + Sex + Cohort0 + thorax_c)^2 + (1 + Cohort0 + Sex |Treatment:Replicate),
                   data = data_wide2,
                   subset = (data_wide2$OtherTraits == "head"))
Anova(head_mod2)

wingL_mod2 <- lmer(length_mm ~ (Treatment + Sex + Cohort0 + thorax_c)^2 + (1 + Cohort0 + Sex |Treatment:Replicate),
                   data = data_wide2,
                   subset = (data_wide2$OtherTraits == "wingLength"))
Anova(wingL_mod2)

wingW_mod2 <- lmer(length_mm ~ (Treatment + Sex + Cohort0 + thorax_c)^2 + (1 + Cohort0 + Sex |Treatment:Replicate),
                   data = data_wide2,
                   subset = (data_wide2$OtherTraits == "wingWidth"))
Anova(wingW_mod2)

femur_allom2 <- lmer(log2(length_mm) ~ (Treatment + Sex + log2(thorax))^3 + (1 + Sex |Treatment:Replicate),
                   data = data_wide2,
                   subset = (data_wide2$OtherTraits == "femur"))
Anova(femur_allom2)

tibia_allom2 <- lmer(log2(length_mm) ~ (Treatment + Sex + log2(thorax))^3 + (1 + Sex |Treatment:Replicate),
                   data = data_wide2,
                   subset = (data_wide2$OtherTraits == "tibia"))
Anova(tibia_allom2)

head_allom2 <- lmer(log2(length_mm) ~ (Treatment + Sex + log2(thorax))^3 + (1 + Sex |Treatment:Replicate),
                   data = data_wide2,
                   subset = (data_wide2$OtherTraits == "head"))
Anova(head_allom2)

wingL_allom2 <- lmer(log2(length_mm) ~ (Treatment + Sex + log2(thorax))^3 + (1 + Sex |Treatment:Replicate),
                   data = data_wide2,
                   subset = (data_wide2$OtherTraits == "wingLength"))
Anova(wingL_allom2)

wingW_allom2 <- lmer(log2(length_mm) ~ (Treatment + Sex + log2(thorax))^3 + (1 + Sex |Treatment:Replicate),
                   data = data_wide2,
                   subset = (data_wide2$OtherTraits == "wingWidth"))
Anova(wingW_allom2)
```
#models don't seem to have changed overall

```{r}
f_fit <- as.data.frame(predictorEffects(femur_mod2, ~ Cohort0, focal.levels = 3, xlevels = 1))
f_fit <- as.data.frame(f_fit)
f_fit <- f_fit %>% 
  rename(Cohort0 = Cohort0.Cohort0, Treatment = Cohort0.Treatment, Sex = Cohort0.Sex,
         thorax_c = Cohort0.thorax_c, femur_fit = Cohort0.fit, femur_se = Cohort0.se, 
         femur_lower = Cohort0.lower, femur_upper = Cohort0.upper)

t_fit <- as.data.frame(predictorEffects(tibia_mod2, ~ Cohort0, focal.levels = 3, xlevels = 1))
t_fit <- as.data.frame(t_fit)
t_fit <- t_fit %>% 
    rename(Cohort0 = Cohort0.Cohort0, Treatment = Cohort0.Treatment, 
           Sex = Cohort0.Sex, thorax_c = Cohort0.thorax_c, tibia_fit = Cohort0.fit, 
           tibia_se = Cohort0.se, tibia_lower = Cohort0.lower, 
           tibia_upper = Cohort0.upper)

h_fit <- as.data.frame(predictorEffects(head_mod2, ~ Cohort0, focal.levels = 3, xlevels = 1))
h_fit <- as.data.frame(h_fit)
h_fit <- h_fit %>% 
    rename(Cohort0 = Cohort0.Cohort0, Treatment = Cohort0.Treatment, 
           Sex = Cohort0.Sex, thorax_c = Cohort0.thorax_c, head_fit = Cohort0.fit, 
           head_se = Cohort0.se, head_lower = Cohort0.lower, 
           head_upper = Cohort0.upper)

wL_fit <- as.data.frame(predictorEffects(wingL_mod2, ~ Cohort0, focal.levels = 3, xlevels = 1))
wL_fit <- as.data.frame(wL_fit)
wL_fit <- wL_fit %>% 
    rename(Cohort0 = Cohort0.Cohort0, Treatment = Cohort0.Treatment, 
           Sex = Cohort0.Sex, thorax_c = Cohort0.thorax_c, wingL_fit = Cohort0.fit, 
           wingL_se = Cohort0.se, wingL_lower = Cohort0.lower, 
           wingL_upper = Cohort0.upper)

wW_fit <- as.data.frame(predictorEffects(wingW_mod2, ~ Cohort0, focal.levels = 3, xlevels = 1))
wW_fit <- as.data.frame(wW_fit)
wW_fit <- wW_fit %>% 
    rename(Cohort0 = Cohort0.Cohort0, Treatment = Cohort0.Treatment, 
           Sex = Cohort0.Sex, thorax_c = Cohort0.thorax_c, wingW_fit = Cohort0.fit, 
           wingW_se = Cohort0.se, wingW_lower = Cohort0.lower,
           wingW_upper = Cohort0.upper)

mod2_fits <- cbind(f_fit, t_fit[, 5:8], h_fit[, 5:8], wL_fit[, 5:8], wW_fit[, 5:8])

mod2_fits <- mod2_fits %>% 
  gather(v, value, femur_fit:wingW_upper) %>% 
  separate(v, c("ModelTrait", "col")) %>% 
  arrange(Cohort0) %>% 
  spread(col, value)

f_allom <- as.data.frame(predictorEffects(femur_allom2, ~ (log2(thorax)),
                                              focal.levels = 200))
f_allom <- as.data.frame(f_allom)
f_allom <- f_allom %>% 
  rename(thorax = thorax.thorax, Treatment = thorax.Treatment, 
         Sex = thorax.Sex, femur_fit = thorax.fit,
         femur_se = thorax.se, femur_lower = thorax.lower, 
         femur_upper = thorax.upper)

t_allom <- as.data.frame(predictorEffects(tibia_allom2, ~ (log2(thorax)),
                                              focal.levels = 200))
t_allom <- as.data.frame(t_allom)
t_allom <- t_allom %>% 
  rename(thorax = thorax.thorax, Treatment = thorax.Treatment, 
         Sex = thorax.Sex, tibia_fit = thorax.fit,
         tibia_se = thorax.se, tibia_lower = thorax.lower, 
         tibia_upper = thorax.upper)

h_allom <- as.data.frame(predictorEffects(head_allom2, ~ (log2(thorax)),
                                              focal.levels = 200))
h_allom <- as.data.frame(h_allom)
h_allom <- h_allom %>% 
  rename(thorax = thorax.thorax, Treatment = thorax.Treatment, 
         Sex = thorax.Sex, head_fit = thorax.fit,
         head_se = thorax.se, head_lower = thorax.lower, 
         head_upper = thorax.upper)

wL_allom <- as.data.frame(predictorEffects(wingL_allom2, ~ (log2(thorax)),
                                              focal.levels = 200))
wL_allom <- as.data.frame(wL_allom)
wL_allom <- wL_allom %>% 
  rename(thorax = thorax.thorax, Treatment = thorax.Treatment, 
         Sex = thorax.Sex, wingL_fit = thorax.fit,
         wingL_se = thorax.se, wingL_lower = thorax.lower, 
         wingL_upper = thorax.upper)

wW_allom <- as.data.frame(predictorEffects(wingW_allom2, ~ (log2(thorax)),
                                              focal.levels = 200))
wW_allom <- as.data.frame(wW_allom)
wW_allom <- wW_allom %>% 
  rename(thorax = thorax.thorax, Treatment = thorax.Treatment, 
         Sex = thorax.Sex, wingW_fit = thorax.fit,
         wingW_se = thorax.se, wingW_lower = thorax.lower, 
         wingW_upper = thorax.upper)

mod2_alloms <- cbind(f_allom, t_allom[, 4:7], h_allom[, 4:7], wL_allom[, 4:7], wW_allom[, 4:7])

mod2_alloms <- mod2_alloms %>% 
  gather(v, value, femur_fit:wingW_upper) %>% 
  separate(v, c("ModelTrait", "col")) %>% 
  arrange(thorax) %>% 
  spread(col, value)
```


Original vs. without UCT replicate 3 and 4 data
Not working right now
```{r}
trait_labs2 <- c("Femur", "Tibia", "Head", "Wing Length", "Wing Width")
names(trait_labs2) <- c("femur_fit", "tibia_fit", "head_fit", "wingL_fit", "wingW_fit")

ggplot(mod2_fits, aes(as.factor(Cohort0), fit, colour = Treatment, shape = Sex)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), size = 1,
                  position = position_jitterdodge(dodge.width = 0.6)) +
  facet_wrap(~ModelTrait, scales = "free_y", labeller = labeller(ModelTrait = trait_labs)) +
  scale_colour_manual(breaks = c("NT", "UCT", "SCT"), values = c("#616161", "#E69F00", "#039BE5")) +
  scale_x_discrete(breaks = c("0", "1", "2"), labels = c("1", "2", "3")) +
  theme_classic(base_size = 20) + 
  labs(x = "Condition Cohort", y = "Size (mm)") +
  theme(legend.position = "none")

ggplot(mod2_alloms, aes(log2(thorax), fit)) +
  geom_line(aes(lty = Sex, colour = Treatment), size = 1.3) +
  geom_ribbon(aes(min = lower, max = upper, fill = Treatment, lty = Sex), alpha = 0.3) +
  facet_wrap(~ModelTrait, scales = "free_y", labeller = labeller(ModelTrait = trait_labs)) +
  scale_fill_manual(breaks = c("NT", "UCT", "SCT"), values = c("#616161", "#E69F00", "#039BE5")) + 
  scale_colour_manual(breaks = c("NT", "UCT", "SCT"), values = c("#616161", "#E69F00", "#039BE5")) + 
  theme_classic(base_size = 20) + 
  labs(x = "log2 Thorax (mm)", y = "log2 Size (mm)") +
  theme(legend.position = "none")
```
